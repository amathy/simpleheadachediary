<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Headache Diary</title>
    <style>
        :root {
            --primary-blue: #E6F3FF;
            --secondary-blue: #B3D9FF;
            --primary-purple: #E6E6FA;
            --secondary-purple: #D8BFD8;
            --light-grey: #F5F5F5;
            --dark-grey: #666666;
            --highlight: #E6E6FA;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: var(--primary-blue);
            color: var(--dark-grey);
        }

        .container {
            max-width: 100%;
            padding: 10px;
            margin: 0 auto;
        }

        .title {
            text-align: center;
            padding: 10px;
            background-color: var(--secondary-purple);
            color: var(--dark-grey);
            margin-bottom: 10px;
        }

        .navbar {
            position: sticky;
            top: 0;
            background-color: var(--secondary-blue);
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            z-index: 100;
        }

        .year-nav {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .current-year {
            font-size: 1.5em;
            font-weight: bold;
        }

        :root {
            --primary-blue: #E6F3FF;
            --secondary-blue: #B3D9FF;
            --primary-purple: #E6E6FA;
            --secondary-purple: #9370DB;
            --light-grey: #F5F5F5;
            --dark-grey: #666666;
            --highlight: #E6E6FA;
        }

        button {
            padding: 8px 16px;
            border: 2px solid var(--secondary-purple);
            border-radius: 20px;
            background-color: #FFFFFF;
            color: var(--dark-grey);
            cursor: pointer;
            font-weight: 500;
            outline: none;
            position: relative;
            overflow: hidden;
        }

        button::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--primary-purple);
            opacity: 0;
            pointer-events: none;
        }

        button:hover::after {
            opacity: 1;
        }

        button.button-pressed {
            background-color: var(--secondary-purple);
            color: white;
        }

        button.button-pressed::after {
            display: none;
        }

        .month-table {
            width: 100%;
            margin-bottom: 20px;
            border-collapse: collapse;
        }

        .month-title {
            background-color: var(--secondary-blue);
            padding: 5px;
            text-align: center;
            color: var(--dark-grey);
        }

        .diary-cell {
            width: calc(100% / 7);
            height: 100px;
            border: 1px solid var(--secondary-blue);
            background-color: white;
            padding: 5px;
            cursor: pointer;
        }

        .diary-cell.today {
            background-color: var(--highlight);
        }

        .date {
            color: var(--secondary-purple);
            font-size: 0.9em;
        }

        .entry-type, .severity, .medication {
            text-align: center;
            font-weight: bold;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal-content {
            position: relative;
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            border-radius: 10px;
        }

        .modal-row {
            margin: 20px 0;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .close {
            position: absolute;
            right: 10px;
            top: 10px;
            cursor: pointer;
        }

        @media (max-width: 600px) {
            .diary-cell {
                height: 80px;
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">Headache Diary</h1>
        
        <div class="navbar">
            <div class="year-nav">
                <button onclick="changeYear(-1)">&lt;&lt;</button>
                <span class="current-year"></span>
                <button onclick="changeYear(1)">&gt;&gt;</button>
            </div>
            <div>
                <button onclick="shareDiary()">Share</button>
                <button onclick="showDeleteModal()">Delete Data</button>
            </div>
        </div>

        <div id="diary-content"></div>
    </div>

        <!-- Cell Change Modal -->
    <div id="cellModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('cellModal')">&times;</span>
            <h2 id="modalDate"></h2>
            
            <div class="modal-row">
                <label>Did you have a:</label>
                <div class="modal-buttons" id="headacheButtons">
                    <button data-type="M" onclick="selectHeadacheType(this, 'M')">Migraine</button>
                    <button data-type="H" onclick="selectHeadacheType(this, 'H')">Headache</button>
                </div>
            </div>
            
            <div class="modal-row">
                <label>Severity:</label>
                <div class="modal-buttons" id="severityButtons">
                    <button data-severity="mild" onclick="selectSeverity(this, 'mild')">Mild</button>
                    <button data-severity="mod" onclick="selectSeverity(this, 'mod')">Moderate</button>
                    <button data-severity="sev" onclick="selectSeverity(this, 'sev')">Severe</button>
                </div>
            </div>
            
            <div class="modal-row">
                <label>Treatment:</label>
                <div class="modal-buttons">
                    <button onclick="toggleMedication(this)">Did you take a painkiller or triptan?</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <h2>Warning</h2>
            <p>This will delete your diary data</p>
            <div class="modal-buttons">
                <button onclick="deleteData()">Continue</button>
                <button onclick="closeModal('deleteModal')">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        let currentYear = new Date().getFullYear();
        let selectedDate = null;
        let diaryData = JSON.parse(localStorage.getItem('headacheDiary')) || {};

        function initializeDiary() {
            document.querySelector('.current-year').textContent = currentYear;
            renderDiary();
            scrollToToday();
        }

        function renderDiary() {
            const content = document.getElementById('diary-content');
            content.innerHTML = '';
            
            const months = Array.from({length: 12}, (_, i) => {
                return new Date(currentYear, i, 1);
            });

            months.forEach(month => {
                content.appendChild(createMonthTable(month));
            });
        }

        function createMonthTable(month) {
            const daysInMonth = new Date(month.getFullYear(), month.getMonth() + 1, 0).getDate();
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                              'July', 'August', 'September', 'October', 'November', 'December'];

            const table = document.createElement('table');
            table.className = 'month-table';
            
            const caption = table.createCaption();
            caption.className = 'month-title';
            caption.textContent = monthNames[month.getMonth()];

            let currentRow;
            for (let day = 1; day <= daysInMonth; day++) {
                if (day % 7 === 1) {
                    currentRow = table.insertRow();
                }

                const cell = currentRow.insertCell();
                cell.className = 'diary-cell';
                
                const date = new Date(month.getFullYear(), month.getMonth(), day);
                const dateString = date.toISOString().split('T')[0];
                
                if (isToday(date)) {
                    cell.classList.add('today');
                }

                cell.innerHTML = `
                    <div class="date">${day}</div>
                    <div class="entry-type">${diaryData[dateString]?.type || ''}</div>
                    <div class="severity">${diaryData[dateString]?.severity || ''}</div>
                    <div class="medication">${diaryData[dateString]?.medication ? 'x' : ''}</div>
                `;

                cell.onclick = () => openCellModal(dateString);
            }

            return table;
        }

        function isToday(date) {
            const today = new Date();
            return date.getDate() === today.getDate() &&
                   date.getMonth() === today.getMonth() &&
                   date.getFullYear() === today.getFullYear();
        }

        function openCellModal(date) {
            selectedDate = date;
            document.getElementById('modalDate').textContent = new Date(date).toLocaleDateString();
            document.getElementById('cellModal').style.display = 'block';
            
            // Reset button states
            const buttons = document.querySelectorAll('#cellModal button');
            buttons.forEach(button => button.classList.remove('button-pressed'));
            
            // Set button states based on existing data
            if (diaryData[date]) {
                const data = diaryData[date];
                if (data.type) {
                    document.querySelector(`button:contains('${data.type === 'M' ? 'Migraine' : 'Headache'}')`).classList.add('button-pressed');
                }
                if (data.severity) {
                    const severityMap = {'mild': 'Mild', 'mod': 'Moderate', 'sev': 'Severe'};
                    document.querySelector(`button:contains('${severityMap[data.severity]}')`).classList.add('button-pressed');
                }
                if (data.medication) {
                    document.querySelector('button:contains("painkiller")').classList.add('button-pressed');
                }
            }
        }

        function selectHeadacheType(button, type) {
            if (!selectedDate) return;
            
            diaryData[selectedDate] = diaryData[selectedDate] || {};
            const buttons = document.querySelectorAll('#headacheButtons button');
            
            if (button.classList.contains('button-pressed')) {
                // If clicking already selected button, deselect it
                button.classList.remove('button-pressed');
                diaryData[selectedDate].type = '';
            } else {
                // Clear all buttons first
                buttons.forEach(btn => btn.classList.remove('button-pressed'));
                // Select the clicked button
                button.classList.add('button-pressed');
                diaryData[selectedDate].type = type;
            }
            
            saveAndUpdate();
        }

        function selectSeverity(button, severity) {
            if (!selectedDate) return;
            
            diaryData[selectedDate] = diaryData[selectedDate] || {};
            const buttons = document.querySelectorAll('#severityButtons button');
            
            if (button.classList.contains('button-pressed')) {
                // If clicking already selected button, deselect it
                button.classList.remove('button-pressed');
                diaryData[selectedDate].severity = '';
            } else {
                // Clear all buttons first
                buttons.forEach(btn => btn.classList.remove('button-pressed'));
                // Select the clicked button
                button.classList.add('button-pressed');
                diaryData[selectedDate].severity = severity;
            }
            
            saveAndUpdate();
        }

        function toggleMedication(button) {
            if (!selectedDate) return;
            
            diaryData[selectedDate] = diaryData[selectedDate] || {};
            
            if (button.classList.contains('button-pressed')) {
                button.classList.remove('button-pressed');
                diaryData[selectedDate].medication = false;
            } else {
                button.classList.add('button-pressed');
                diaryData[selectedDate].medication = true;
            }
            
            saveAndUpdate();
        }

        function saveAndUpdate() {
            localStorage.setItem('headacheDiary', JSON.stringify(diaryData));
            renderDiary();
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            selectedDate = null;
        }

        function changeYear(delta) {
            currentYear += delta;
            document.querySelector('.current-year').textContent = currentYear;
            renderDiary();
        }

        function showDeleteModal() {
            document.getElementById('deleteModal').style.display = 'block';
        }

        function deleteData() {
            localStorage.removeItem('headacheDiary');
            diaryData = {};
            location.reload();
        }

        function scrollToToday() {
            const today = document.querySelector('.today');
            if (today) {
                today.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        async function shareDiary() {
            const report = generateDiaryReport();
            const htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Headache Diary Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; line-height: 1.6; }
                        table { border-collapse: collapse; width: 100%; max-width: 800px; margin: 20px 0; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        h1, h2 { color: #333; }
                    </style>
                </head>
                <body>
                    ${report}
                </body>
                </html>`;
            
            // Create a Blob containing the HTML content
            const blob = new Blob([htmlContent], { type: 'text/html' });
            
            try {
                // Try native sharing first
                if (navigator.canShare && navigator.canShare({ files: [new File([blob], 'report.html', { type: 'text/html' })] })) {
                    await navigator.share({
                        files: [new File([blob], 'report.html', { type: 'text/html' })],
                        title: 'Headache Diary Report',
                    });
                } else {
                    // Fallback to creating a downloadable file
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'headache-diary-report.html';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }
            } catch (err) {
                console.error('Sharing failed:', err);
                alert('Unable to share diary report. Creating downloadable file instead.');
                // Fallback to creating a downloadable file
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'headache-diary-report.html';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        }

        function generateDiaryReport() {
            const today = new Date();
            const last30Days = new Date(today);
            last30Days.setDate(today.getDate() - 30);
            
            let headacheDays = 0;
            let migraineDays = 0;
            let painkillerDays = 0;

            // Count totals for last 30 days
            for (let date in diaryData) {
                const entryDate = new Date(date);
                if (entryDate >= last30Days && entryDate <= today) {
                    const entry = diaryData[date];
                    if (entry.type === 'H' || entry.type === 'M') headacheDays++;
                    if (entry.type === 'M') migraineDays++;
                    if (entry.medication) painkillerDays++;
                }
            }

            // Generate the last 90 days table
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                              'July', 'August', 'September', 'October', 'November', 'December'];
            
            // Get the last 4 calendar months
            let months = [];
            let currentDate = new Date(today);
            for (let i = 0; i < 4; i++) {
                months.unshift(new Date(currentDate));
                currentDate.setMonth(currentDate.getMonth() - 1);
            }

            // Generate the DTABLE
            let dtableHtml = `
                <table border="1" style="margin-top: 20px; border-collapse: collapse;">
                    <tr>
                        <th style="padding: 5px;">Month</th>
                        ${Array.from({length: 31}, (_, i) => `<th style="padding: 5px;">${i + 1}</th>`).join('')}
                    </tr>`;

            months.forEach(month => {
                const daysInMonth = new Date(month.getFullYear(), month.getMonth() + 1, 0).getDate();
                let row = `<tr>
                    <td style="padding: 5px;">${monthNames[month.getMonth()]}</td>`;
                
                for (let day = 1; day <= 31; day++) {
                    if (day <= daysInMonth) {
                        const date = new Date(month.getFullYear(), month.getMonth(), day);
                        const dateString = date.toISOString().split('T')[0];
                        const entry = diaryData[dateString] || {};
                        
                        let cellContent = '';
                        if (entry.type) {
                            cellContent += `${entry.type}<br>`;
                            if (entry.severity) cellContent += `${entry.severity}<br>`;
                            if (entry.medication) cellContent += 'x';
                        }
                        
                        row += `<td style="padding: 5px; text-align: center;">${cellContent}</td>`;
                    } else {
                        row += '<td style="padding: 5px; background-color: #f0f0f0;"></td>';
                    }
                }
                row += '</tr>';
                dtableHtml += row;
            });
            dtableHtml += '</table>';

            return `
                <h1>Headache Diary Summary on ${today.toLocaleDateString()}</h1>
                <h2>Last 30 Day Summary:</h2>
                <table style="margin-bottom: 20px; border-collapse: collapse;" border="1">
                    <tr><td style="padding: 5px;">Total headache days:</td><td style="padding: 5px;">${headacheDays}</td></tr>
                    <tr><td style="padding: 5px;">Total migraine days:</td><td style="padding: 5px;">${migraineDays}</td></tr>
                    <tr><td style="padding: 5px;">Total painkiller days:</td><td style="padding: 5px;">${painkillerDays}</td></tr>
                </table>
                <h2>Last 90 Days Detail:</h2>
                ${dtableHtml}
            `;
        }

        // Helper function for button selection
        HTMLElement.prototype.contains = function(text) {
            return this.textContent.includes(text);
        };

        // Initialize the diary
        initializeDiary();

        // Handle modal closing when clicking outside
        window.onclick = function(event) {
            if (event.target.className === 'modal') {
                event.target.style.display = 'none';
                selectedDate = null;
            }
        }
    </script>
</body>
</html>